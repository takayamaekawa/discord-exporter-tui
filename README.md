# Discord Chat to XLSX Exporter

DiscordチャンネルのメッセージをExcelファイル（XLSX）にエクスポートするPythonスクリプトです。

## 機能

- 🖥️ **メインメニューシステム**: 直感的なターミナルUIで簡単操作
- ⚙️ **設定UI**: Botトークンや出力設定を視覚的に管理
- 📊 **複数チャンネル対応**: 複数のチャンネルを選択して一度にエクスポート
- 🎯 **高度な選択UI**: カテゴリー別チャンネル表示、カテゴリ一括選択、チェックボックス選択
- ⌨️ **Vimスタイル操作**: jkキーでの移動、hlキーでのページ移動、スペースキーでの選択、直感的なキーボードナビゲーション
- ⚡ **メッセージ数推定**: 処理前に推定メッセージ数を表示、大量データ警告のスキップ設定可能
- 📈 **豊富な統計情報**: チャンネル別、ユーザー別、全体統計を自動生成
- 🔍 **詳細なメッセージ情報**: 添付ファイル、リアクション、メンション、返信情報を含む
- 📅 **日付範囲指定**: 特定の期間のメッセージのみエクスポート可能
- 🎛️ **メッセージ数制限**: チャンネル毎にメッセージ数制限を設定可能

## 必要な環境

- Python 3.7+
- Discord Bot Token

## インストール

1. インストール：
```bash
curl -fsSL https://provider.maekawa.dev/scripts/install.sh | bash
```
または、以下のコマンドで手動インストール：
```bash
git clone https://github.com/takayamaekawa/discord-exporter.git
cd discord-exporter
pip install -r requirements.txt
python discord_exporter.py
```

2. Discord Bot Tokenを取得：
   - [Discord Developer Portal](https://discord.com/developers/applications)でBotを作成
   - Bot TokenをコピーしてBotに必要な権限を付与
   - サーバーにBotを招待

## 使用方法

### 簡単な3ステップで開始

#### ステップ1: メインメニューを起動
```bash
python discord_exporter.py
```

#### ステップ2: 設定を入力
- メインメニューから「設定を変更」を選択
- Discord Bot Tokenを入力
- 出力ファイル名を設定
- 日付範囲・メッセージ数制限を任意で設定

#### ステップ3: エクスポート実行
- 「チャンネル情報を更新」でサーバーのチャンネル情報を取得
- 「チャンネルを選択してエクスポート」でエクスポートしたいチャンネルを選択

## ユーザーインターフェース

### メインメニュー
```
============================================================
🎯 Discord Exporter メインメニュー
============================================================
📊 チャンネル情報: 50 チャンネル
最終更新: 2025-07-07 02:54:14

メニュー:
→ 1. チャンネル情報を更新
  2. チャンネルを選択してエクスポート
  3. 設定を変更
  4. 終了

↑↓/jk: 移動 | ENTER: 選択 | Q: 終了
```

### 設定画面
```
Discord Exporter 設定
↑↓/jk: 移動 | ENTER: 編集/選択 | TAB: 次へ | F10: 保存してメニューに戻る | ESC: キャンセル
================================================================================

→ Discord Bot Token: [設定済み]
  出力ファイル名: discord_export.xlsx
  開始日 (YYYY-MM-DD): 
  終了日 (YYYY-MM-DD): 
  メッセージ数制限: 

F10: 保存してメニューに戻る
```

### チャンネル選択画面
```
Discord Exporter - チャンネル選択
↑↓/jk: 移動 | SPACE: チェック | A: 全選択/解除 | ENTER: 確定 | Q: キャンセル | ←→: ページ移動
================================================================================

☐ All (すべて選択)

━━━ マイサーバー ━━━
→ ☐ #general (推定: 1,234 メッセージ)
  ☑ #random (推定: 567 メッセージ)
  ☐ #dev (推定: 890 メッセージ)

━━━ プライベート ━━━
  ☐ #private-chat (推定: 123 メッセージ)

ページ: 1/3 | 選択済み: 1 チャンネル | 総推定メッセージ数: 567
```

### キーボード操作

#### メインメニュー
- **↑↓ または j/k**: カーソル移動
- **Enter または Space**: 選択した項目を実行
- **Q**: 終了

#### チャンネル選択画面
- **↑↓ または j/k**: カーソル移動（カテゴリーヘッダーも選択可能）
- **Space**: チャンネルのチェックボックス切り替え / カテゴリ一括選択
- **A**: 全選択/全解除
- **Enter**: 選択を確定してエクスポート開始
- **←→ または h/l**: ページ移動（多数のチャンネルがある場合）
- **Q**: キャンセル

#### 警告画面
- **y**: 警告を表示して継続
- **N**: 処理を中止
- **s**: 今後この警告を表示しないように設定して継続

### コマンドライン引数（上級者向け）

| オプション | 説明 |
|-----------|---------|
| `-t, --token` | Discord Bot Token |
| `--config` | 設定UIを直接起動 |
| `--fetch-channels` | 全チャンネル情報を取得してJSONに保存 |
| `--interactive` | TUIチャンネル選択モード |
| `--cli` | CLIチャンネル選択モード |
| `-c, --channel` | 単一チャンネルID（従来モード） |
| `-o, --output` | 出力Excelファイル名 |
| `--after` | この日付以降のメッセージ（YYYY-MM-DD） |
| `--before` | この日付以前のメッセージ（YYYY-MM-DD） |
| `--limit` | チャンネル毎のメッセージ数制限 |

### 使用例（コマンドライン）

#### 設定UIから開始
```bash
python discord_exporter.py --config
```

#### 従来の方法
```bash
# チャンネル情報を取得
python discord_exporter.py -t "YOUR_BOT_TOKEN" --fetch-channels

# TUIでエクスポート
python discord_exporter.py -t "YOUR_BOT_TOKEN" --interactive -o "discord_export.xlsx"
```

## 出力ファイル形式

生成されるExcelファイルには以下のシートが含まれます：

### 1. All_Messages
全メッセージの詳細情報
- タイムスタンプ
- 投稿者名・ID
- メッセージ内容
- サーバー名・チャンネル名
- 編集日時
- 返信先メッセージ
- 添付ファイル情報
- リアクション情報
- メンション情報
- Bot判定
- メッセージタイプ

### 2. Channel_Statistics
チャンネル別統計
- メッセージ数
- ユニークユーザー数
- 添付ファイル数
- リアクション数

### 3. User_Statistics
ユーザー別統計（チャンネル毎）
- メッセージ数
- 添付ファイル数
- リアクション数

### 4. Total_Statistics
全体統計
- 総メッセージ数
- 総チャンネル数
- 総ユーザー数
- 総添付ファイル数
- リアクション付きメッセージ数
- エクスポート日時

## 注意事項

### 大量データの処理
- 50,000メッセージを超える場合は警告が表示されます
- 処理時間とメモリ使用量が大きくなる可能性があります
- 日付範囲指定やメッセージ数制限の使用を推奨します

### Bot権限
Botには以下の権限が必要です：
- `Read Messages`
- `Read Message History`
- `View Channels`

### レート制限
- Discord APIのレート制限により、大量のメッセージ取得時は時間がかかる場合があります
- 100メッセージ毎に進捗が表示されます

## ファイル構造

```
discord_exporter/
├── discord_exporter.py    # メインスクリプト
├── requirements.txt       # 依存関係
├── README.md             # このファイル
├── config.json           # 設定ファイル（自動生成）
└── channels.json         # チャンネル情報（自動生成）
```

## トラブルシューティング

### よくある問題

1. **Bot Tokenが無効**
   - Discord Developer Portalでトークンを確認
   - トークンが正しく入力されているか確認

2. **チャンネルが見つからない**
   - Botがそのチャンネルにアクセス権を持っているか確認
   - チャンネルIDが正しいか確認

3. **権限エラー**
   - Botに必要な権限が付与されているか確認
   - サーバーでBotが適切な役割を持っているか確認

4. **メモリ不足**
   - 大量のメッセージを扱う場合は、日付範囲やメッセージ数制限を使用
   - より多くのRAMを持つ環境での実行を検討

5. **UIが正常に表示されない**
   - ターミナルが curses をサポートしているか確認
   - コマンドライン引数（`--cli`）での実行を試行

### ログ出力例

```
Discord Exporter を起動中...

🔍 チャンネル情報を取得中...
サーバー: マイサーバー
  #general (推定メッセージ数: 1234)
  #random (推定メッセージ数: 567)
✅ チャンネル情報を channels.json に保存しました

🔄 [マイサーバー] #general を処理中...
  取得済み: 100 メッセージ
  取得済み: 200 メッセージ
✅ general: 234 メッセージ取得完了

✅ エクスポート完了!
   ファイル: discord_export.xlsx
   総メッセージ数: 1,234
   チャンネル数: 2
   ユーザー数: 45
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 貢献

バグ報告や機能要求は、GitHubのIssueでお知らせください。
